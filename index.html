<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ¦é£Ÿå½“ç•ªã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</title>
    <!-- Google Fonts & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            /* ãƒãƒ†ãƒªã‚¢ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³3 (Deep Purple theme) */
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --primary-container: #EADDFF;
            --on-primary-container: #21005D;
            --secondary: #625B71;
            --background: #FFFBFE;
            --surface: #F7F2FA;
            --surface-variant: #E7E0EC;
            --outline: #79747E;
            --error: #B3261E;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Roboto', 'Noto Sans JP', sans-serif;
            background-color: var(--surface);
            color: #1C1B1F;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* ã‚¢ãƒ—ãƒªæœ¬ä½“ã®æ çµ„ã¿ */
        .app-container {
            background-color: var(--background);
            width: 100%;
            max-width: 600px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background-color: var(--surface);
            padding: 16px 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid var(--surface-variant);
        }
        .header-title {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--on-primary-container);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ç”»é¢é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .screen {
            display: none;
            padding: 20px;
            flex-grow: 1;
            flex-direction: column;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .screen.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* UIãƒ‘ãƒ¼ãƒ„ï¼šã‚«ãƒ¼ãƒ‰ */
        .card {
            background: var(--surface-variant); /* å°‘ã—æ¿ƒã„èƒŒæ™¯ã«å¤‰æ›´ */
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            background: #fff; /* ç™½ã«æˆ»ã™ */
            border: 1px solid var(--surface-variant);
        }

        /* UIãƒ‘ãƒ¼ãƒ„ï¼šãƒœã‚¿ãƒ³ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            padding: 0 24px;
            border-radius: 20px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            gap: 8px;
            text-decoration: none;
        }
        .btn:active { transform: scale(0.96); }
        
        .btn-filled { background-color: var(--primary); color: var(--on-primary); box-shadow: var(--shadow); }
        .btn-tonal { background-color: var(--primary-container); color: var(--on-primary-container); }
        .btn-outlined { background-color: transparent; border: 1px solid var(--outline); color: var(--primary); }
        .btn-text { background-color: transparent; color: var(--primary); }

        /* ã‚¯ãƒ©ã‚¹é¸æŠã‚°ãƒªãƒƒãƒ‰ */
        .grade-section {
            margin-bottom: 24px;
        }
        .grade-label {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 8px;
            margin-left: 4px;
            font-weight: bold;
        }
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 12px;
        }
        .class-btn {
            background-color: #fff;
            color: var(--primary);
            border: 1px solid var(--surface-variant);
            padding: 16px 0;
            font-size: 1.1rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: background 0.2s, transform 0.1s;
        }
        .class-btn:hover { background-color: var(--surface-variant); }
        .class-btn:active { background-color: var(--primary-container); border-color: var(--primary); }

        /* ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ */
        .timer-display {
            font-size: 5.5rem;
            font-weight: 400;
            color: var(--on-primary-container);
            text-align: center;
            margin: 40px 0;
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
            line-height: 1;
        }
        
        .fab-container {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 30px;
        }
        
        .fab {
            width: 80px;
            height: 80px;
            border-radius: 28px; /* M3 squircle */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .fab:active { transform: scale(0.95); }
        
        .fab-start { background-color: var(--primary-container); color: var(--on-primary-container); }
        .fab-stop { background-color: var(--error); color: white; }

        /* ãƒªã‚¹ãƒˆ */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .rank-list { list-style: none; padding: 0; margin: 0; }
        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--surface-variant);
        }
        .rank-item:last-child { border-bottom: none; }
        .rank-rank {
            background: var(--primary-container);
            color: var(--on-primary-container);
            width: 28px; height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            margin-right: 12px;
        }
        .rank-date { color: var(--secondary); font-size: 0.9rem; }
        .rank-time { font-family: 'Roboto Mono', monospace; font-weight: 500; color: var(--primary); font-size: 1.1rem; }

        /* ãƒˆãƒ¼ã‚¹ãƒˆ */
        #toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #322F35;
            color: #F4EFF4;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            display: none;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-title">
            <span class="material-icons-round">timer</span> çµ¦é£Ÿå½“ç•ªã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯
        </div>
    </header>

    <!-- â˜…ç”»é¢1ï¼šã‚¯ãƒ©ã‚¹é¸æŠ -->
    <div id="screen-select" class="screen active">
        <div style="text-align: center; margin: 10px 0 30px;">
            <h2 style="font-size:1.5rem; margin:0; color:var(--primary);">ã‚¯ãƒ©ã‚¹ã‚’é¸ã‚“ã§ã­</h2>
            <p style="color:var(--secondary); margin-top:8px;">ã•ã‚ã€è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ã‚’ç›®æŒ‡ãã†ï¼</p>
        </div>
        
        <!-- ã‚¯ãƒ©ã‚¹ãƒœã‚¿ãƒ³ã¯JSã§è‡ªå‹•ç”Ÿæˆã—ã¾ã™ -->
        <div id="classButtonsArea"></div>

        <div style="margin-top: 40px; text-align: center;">
            <button class="btn btn-outlined" onclick="showGlobalRanking()">
                <span class="material-icons-round">leaderboard</span> å…¨ä½“ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹
            </button>
        </div>
    </div>

    <!-- â˜…ç”»é¢2ï¼šã‚¯ãƒ©ã‚¹è¨ˆæ¸¬ & å±¥æ­´ -->
    <div id="screen-timer" class="screen">
        <!-- ä¸Šéƒ¨ãƒŠãƒ“ -->
        <div style="display:flex; align-items:center; margin-bottom:10px;">
            <button class="btn btn-text" style="padding-left:0;" onclick="goHome()">
                <span class="material-icons-round">arrow_back</span> æˆ»ã‚‹
            </button>
            <span style="flex-grow:1; text-align:right; font-weight:bold; color:var(--primary);" id="currentClassLabel"></span>
        </div>

        <!-- ã‚¿ã‚¤ãƒãƒ¼ -->
        <div class="card" style="text-align: center; padding: 30px 20px;">
            <div style="color:var(--secondary); font-size:0.9rem;">TIME</div>
            <div class="timer-display" id="timerDisplay">00:00</div>
            
            <div class="fab-container">
                <button id="btnStart" class="fab fab-start" onclick="startTimer()">
                    <span class="material-icons-round">play_arrow</span>
                </button>
                <button id="btnStop" class="fab fab-stop" onclick="stopTimer()" disabled>
                    <span class="material-icons-round">stop</span>
                </button>
            </div>

            <!-- è¨˜éŒ²ç¢ºèªã‚¨ãƒªã‚¢ -->
            <div id="recordArea" style="display: none; animation: fadeIn 0.3s;">
                <p style="margin-bottom:16px;">ã“ã®ã‚¿ã‚¤ãƒ ã‚’è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-text" onclick="resetTimer()">ã‚„ã‚Šç›´ã™</button>
                    <button class="btn btn-filled" id="btnRecord" onclick="sendData()">
                        <span class="material-icons-round">send</span> è¨˜éŒ²ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- ã“ã®ã‚¯ãƒ©ã‚¹ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
        <div class="list-header">
            <span style="font-weight:bold; color:var(--secondary);">ã‚¯ãƒ©ã‚¹ã®æ­´ä»£ãƒ™ã‚¹ãƒˆ5</span>
            <button class="btn btn-text" style="height:30px; font-size:0.8rem;" onclick="fetchData()">
                <span class="material-icons-round" style="font-size:1rem;">refresh</span> æ›´æ–°
            </button>
        </div>
        <div class="card" style="padding:0; overflow:hidden;">
            <div id="ranking-class-list">
                <div style="padding:20px; text-align:center; color:var(--secondary);">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- â˜…ç”»é¢3ï¼šå…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div id="screen-ranking" class="screen">
        <div style="display:flex; align-items:center; margin-bottom:20px;">
            <button class="btn btn-text" style="padding-left:0;" onclick="goHome()">
                <span class="material-icons-round">arrow_back</span> æˆ»ã‚‹
            </button>
            <span style="font-weight:bold; margin-left:auto;">æœ¬æ—¥ã®å…¨ã‚¯ãƒ©ã‚¹å¯¾æ±º</span>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <div id="ranking-global-list">
                <div style="padding:20px; text-align:center; color:var(--secondary);">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
        <div style="text-align:center; margin-top:10px;">
            <button class="btn btn-tonal" onclick="fetchData()">
                <span class="material-icons-round">refresh</span> æœ€æ–°æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
            </button>
        </div>
    </div>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
</div>

<script>
    // ==========================================
    // â˜…è¨­å®šï¼šã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    // ==========================================
    const API_URL = "â˜…GASã®URLã‚’ã“ã“ã«è²¼ã‚‹â˜…";


    // --- ã‚¢ãƒ—ãƒªã®ãƒ­ã‚¸ãƒƒã‚¯ ---

    let state = {
        className: "",
        startTime: 0,
        elapsedTime: 0,
        timerInterval: null,
        isRunning: false,
        allData: [] // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    };

    // åˆæœŸåŒ–
    window.onload = function() {
        renderClassButtons();
    };

    // ã‚¯ãƒ©ã‚¹ãƒœã‚¿ãƒ³ã®ç”Ÿæˆï¼ˆ1-5å¹´ã¯2ã‚¯ãƒ©ã‚¹ã€6å¹´ã¯3ã‚¯ãƒ©ã‚¹ã€å€‹åˆ¥ç´šï¼‰
    function renderClassButtons() {
        const container = document.getElementById('classButtonsArea');
        let html = '';

        // 1ã€œ5å¹´ç”Ÿ
        for (let g = 1; g <= 5; g++) {
            html += `<div class="grade-section">
                <div class="grade-label">${g}å¹´ç”Ÿ</div>
                <div class="class-grid">
                    <button class="class-btn" onclick="selectClass('${g}-1')">${g}-1</button>
                    <button class="class-btn" onclick="selectClass('${g}-2')">${g}-2</button>
                </div>
            </div>`;
        }

        // 6å¹´ç”Ÿ
        html += `<div class="grade-section">
            <div class="grade-label">6å¹´ç”Ÿ</div>
            <div class="class-grid">
                <button class="class-btn" onclick="selectClass('6-1')">6-1</button>
                <button class="class-btn" onclick="selectClass('6-2')">6-2</button>
                <button class="class-btn" onclick="selectClass('6-3')">6-3</button>
            </div>
        </div>`;

        // å€‹åˆ¥ç´š
        html += `<div class="grade-section">
            <div class="grade-label">ç‰¹åˆ¥æ”¯æ´å­¦ç´š</div>
            <div class="class-grid">
                <button class="class-btn" onclick="selectClass('å€‹åˆ¥ç´š')">å€‹åˆ¥ç´š</button>
            </div>
        </div>`;

        container.innerHTML = html;
    }

    // ç”»é¢é·ç§»
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0, 0);
    }

    function goHome() {
        showScreen('screen-select');
        resetTimer();
    }

    // ã‚¯ãƒ©ã‚¹é¸æŠæ™‚ã®å‡¦ç†
    function selectClass(name) {
        state.className = name;
        document.getElementById('currentClassLabel').innerText = name;
        showScreen('screen-timer');
        fetchData(); // ç”»é¢ã‚’é–‹ã„ãŸç¬é–“ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    }

    // å…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã¸
    function showGlobalRanking() {
        showScreen('screen-ranking');
        fetchData();
    }

    // --- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ ---
    function startTimer() {
        if(state.isRunning) return;
        state.startTime = Date.now() - state.elapsedTime;
        state.isRunning = true;
        
        toggleButtons(true); // ãƒœã‚¿ãƒ³çŠ¶æ…‹å¤‰æ›´
        document.getElementById('recordArea').style.display = 'none';

        state.timerInterval = setInterval(() => {
            state.elapsedTime = Date.now() - state.startTime;
            updateDisplay();
        }, 100);
    }

    function stopTimer() {
        clearInterval(state.timerInterval);
        state.isRunning = false;
        toggleButtons(false);
        document.getElementById('recordArea').style.display = 'block';
    }

    function resetTimer() {
        clearInterval(state.timerInterval);
        state.isRunning = false;
        state.elapsedTime = 0;
        updateDisplay();
        toggleButtons(false);
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStart').style.opacity = "1";
        document.getElementById('recordArea').style.display = 'none';
    }

    function toggleButtons(running) {
        const startBtn = document.getElementById('btnStart');
        const stopBtn = document.getElementById('btnStop');
        
        if (running) {
            startBtn.disabled = true;
            startBtn.style.opacity = "0.5";
            startBtn.style.transform = "scale(0.9)";
            stopBtn.disabled = false;
            stopBtn.style.opacity = "1";
            stopBtn.style.transform = "scale(1)";
        } else {
            startBtn.disabled = false;
            startBtn.style.opacity = "1";
            startBtn.style.transform = "scale(1)";
            stopBtn.disabled = true;
            stopBtn.style.opacity = "0.5";
            stopBtn.style.transform = "scale(0.9)";
        }
    }

    function updateDisplay() {
        let totalSeconds = Math.floor(state.elapsedTime / 1000);
        let m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        let s = (totalSeconds % 60).toString().padStart(2, '0');
        document.getElementById('timerDisplay').innerText = `${m}:${s}`;
    }

    // --- ãƒ‡ãƒ¼ã‚¿é€šä¿¡ ---
    function sendData() {
        const timeText = document.getElementById('timerDisplay').innerText;
        const timeSec = Math.floor(state.elapsedTime / 1000);
        const btn = document.getElementById('btnRecord');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="material-icons-round" style="animation:spin 1s infinite linear">sync</span> é€ä¿¡ä¸­';
        
        if (API_URL.includes("â˜…")) {
            showToast("ã‚¨ãƒ©ãƒ¼ï¼šGASã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
            btn.disabled = false;
            return;
        }

        // é€ä¿¡
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                class: state.className,
                time_sec: timeSec,
                time_text: timeText
            }),
            headers: { "Content-Type": "text/plain" }
        })
        .then(() => {
            showToast("è¨˜éŒ²ã—ã¾ã—ãŸï¼ğŸ‰");
            btn.innerHTML = '<span class="material-icons-round">send</span> è¨˜éŒ²ã™ã‚‹';
            btn.disabled = false;
            resetTimer(); // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            fetchData(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å³æ›´æ–°
        })
        .catch(err => {
            showToast("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
            btn.disabled = false;
        });
    }

    function fetchData() {
        if (API_URL.includes("â˜…")) return;

        fetch(API_URL)
        .then(res => res.json())
        .then(data => {
            state.allData = data;
            renderRankings(data);
        })
        .catch(err => {
            console.error(err);
            showToast("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        });
    }

    function renderRankings(data) {
        // --- 1. ã‚¯ãƒ©ã‚¹åˆ¥ æ­´ä»£ãƒ™ã‚¹ãƒˆ5 ---
        if (state.className) {
            const classData = data.filter(d => d.class === state.className);
            classData.sort((a, b) => a.time_sec - b.time_sec); // é€Ÿã„é †

            let html = '<ul class="rank-list">';
            classData.slice(0, 5).forEach((row, i) => {
                let dateStr = row.date.substring(5).replace('-', '/'); // MM/DD
                html += `
                    <li class="rank-item">
                        <div style="display:flex; align-items:center;">
                            <span class="rank-rank">${i+1}</span>
                            <span class="rank-date">${dateStr}</span>
                        </div>
                        <span class="rank-time">${row.time_text}</span>
                    </li>`;
            });
            html += '</ul>';
            if(classData.length === 0) html = '<div style="padding:20px; text-align:center; color:#999;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“<br>æœ€åˆã®è¨˜éŒ²ã‚’ä½œã‚ã†ï¼</div>';
            document.getElementById('ranking-class-list').innerHTML = html;
        }

        // --- 2. æœ¬æ—¥ã®å…¨ã‚¯ãƒ©ã‚¹ãƒ©ãƒ³ã‚­ãƒ³ã‚° (TOP 10) ---
        const todayStr = new Date().toLocaleDateString('ja-JP', {year: 'numeric', month: '2-digit', day: '2-digit'}).replaceAll('/', '-');
        
        // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
        const todayData = data.filter(d => d.date === todayStr);
        // é€Ÿã„é †
        todayData.sort((a, b) => a.time_sec - b.time_sec);

        let htmlGlobal = '<ul class="rank-list">';
        todayData.slice(0, 10).forEach((row, i) => {
            let rankColor = i===0 ? '#FFD700' : (i===1 ? '#C0C0C0' : (i===2 ? '#CD7F32' : 'var(--primary-container)'));
            let rankTextColor = i < 3 ? '#333' : 'var(--on-primary-container)';
            
            htmlGlobal += `
                <li class="rank-item">
                    <div style="display:flex; align-items:center;">
                        <span class="rank-rank" style="background:${rankColor}; color:${rankTextColor};">${i+1}</span>
                        <span style="font-weight:bold;">${row.class}</span>
                    </div>
                    <span class="rank-time">${row.time_text}</span>
                </li>`;
        });
        htmlGlobal += '</ul>';
        if(todayData.length === 0) htmlGlobal = '<div style="padding:30px; text-align:center; color:#999;">ä»Šæ—¥ã®è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸€ç•ªä¹—ã‚Šã‚’ç›®æŒ‡ãã†ï¼</div>';
        document.getElementById('ranking-global-list').innerHTML = htmlGlobal;
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 3000);
    }
</script>

<style>
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>

</body>
</html>


